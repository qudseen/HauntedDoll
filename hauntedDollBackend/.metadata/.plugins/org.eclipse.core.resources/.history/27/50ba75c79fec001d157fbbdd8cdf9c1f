package com.development.dao;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Map;
import java.util.TreeMap;
import java.util.TreeSet;
import java.util.Set;
import java.util.List;
import java.util.LinkedList;

import com.development.domain.Cart;
import com.development.domain.Order;
import static com.development.dao.DBConstants.*;

public class CartDAO {

	private Connection connection;
    DbDAO dbDAO;  // for common DB methods
    
	public CartDAO(DbDAO db) {
		dbDAO = db;
		connection = db.getConnection();
	}

	public List<Cart> getCart(int userid) throws SQLException {
		String sqlString =
			"SELECT o.*, s.*, n.*, u.*, eot.* "
			+ "FROM " + CART_TABLE+ " o LEFT OUTER JOIN " + DOLL_EXTRA_OPTIONS_TABLE + " eot " +
			" ON o.id = eot.cart_id " +
			"JOIN " + DOLL_SIZES_TABLE + " s ON o.size_id = s.id " + 
			"JOIN " + DOLL_NAMES_TABLE + " n ON o.name_id = n.id " + 
			"JOIN " + USERS_TABLE + " u ON o.user_id = u.id " + 
			((userid > 0) ? ("WHERE o.user_id = " + userid) : "") +
			" ORDER BY o.id";
		
		Map<Integer, Cart> statusMap = new TreeMap<Integer, Cart>();
		Statement stmt = connection.createStatement();

		try {
			ResultSet table = stmt.executeQuery(sqlString);

			while (table.next()) {
				int ordNo = table.getInt("cart_id");
				Cart cart = null;
				String extras_name = table.getString("extra_option_name");
				if ((cart = (Cart) statusMap.get(ordNo)) != null) {
					cart.addExtras(extras_name);
				} else {
					List<String> extras = new LinkedList<String>();
					extras.add(extras_name);
					String name = table.getString("username");
					String address = table.getString("address");
					String dollName = table.getString("doll_name");
					String dollSize = table.getString("size_name");
					int day = table.getInt("day");
					int status = table.getInt("status");
					
					cart = new Cart(ordNo, name, dollName, dollSize, extras);
					statusMap.put(ordNo, cart);
				}
			}
		} finally {
			stmt.close();
		}
		return new LinkedList<Cart>(statusMap.values());
	}

}
